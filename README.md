# zkP-KYC System (State of Residence Verifier)

This repository demonstrates a minimal zero-knowledge KYC-style flow that verifies a user's "state of residence" using a Circom circuit, snarkJS (Groth16), and a Solidity verifier + coordination contract deployed with Hardhat.

This README explains how to:
- Install dependencies
- Build circuits and generate keys / proofs
- Compile and deploy Solidity contracts
- Run tests and scripts
- Overview of the technologies used and the repository layout

Prerequisites
- Node.js (>=16 recommended)
- npm or yarn
- npx available (comes with npm)
- (Optional) Docker when you prefer containerized tooling
- For compiling circuits: circom (v2) and snarkjs. You can install globally or use local npm packages.

Quick setup
1. Clone repository (already present for you).
2. Install JS dependencies:
   npm install
   or
   yarn

3. Install Circom + snarkjs (global or local):
   - Global (recommended for convenience):
     npm install -g circom
     npm install -g snarkjs
   - Or add as devDependencies to the project:
     npm install --save-dev circom snarkjs

Building & verifying contracts (Hardhat)
- Compile Solidity:
  npx hardhat compile

- Run tests:
  npx hardhat test

- Start a local node:
  npx hardhat node

- Deploy (if you have a deploy script under scripts/):
  npx hardhat run --network localhost scripts/deploy.js

Circuits: compile, setup, witness, prove, verifier export
This project uses Circom circuits and snarkjs for Groth16 proofs. Typical workflow for a circuit:

1. Compile the circuit (.circom -> .r1cs, .wasm, .sym):
   circom circuits/YourCircuit.circom --r1cs --wasm --sym -o circuits/build

2. Run a trusted setup (Groth16) or produce a powers-of-tau if needed:
   # Example quick steps (dev only)
   snarkjs groth16 setup circuits/build/YourCircuit.r1cs circuits/build/YourCircuit_0000.zkey
   snarkjs zkey export verificationkey circuits/build/YourCircuit_0000.zkey circuits/build/verification_key.json

   For real usage you should generate a powers-of-tau first, then contribute randomness, etc:
   snarkjs powersoftau new bn128 12 pot12_0000.ptau
   snarkjs powersoftau contribute pot12_0000.ptau pot12_0001.ptau --name="first contribution" -v

   snarkjs groth16 setup circuits/build/YourCircuit.r1cs pot12_0001.ptau circuits/build/YourCircuit_0000.zkey
   snarkjs zkey contribute circuits/build/YourCircuit_0000.zkey circuits/build/YourCircuit_final.zkey --name="contrib" -v
   snarkjs zkey export verificationkey circuits/build/YourCircuit_final.zkey circuits/build/verification_key.json

3. Generate witness (uses the wasm produced when compiling):
   # Provide input.json according to circuit inputs
   node circuits/build/YourCircuit_js/generate_witness.js circuits/build/YourCircuit_js/YourCircuit.wasm input.json circuits/build/witness.wtns

4. Generate proof and public signals:
   snarkjs groth16 prove circuits/build/YourCircuit_final.zkey circuits/build/witness.wtns circuits/build/proof.json circuits/build/public.json

5. Verify proof locally:
   snarkjs groth16 verify circuits/build/verification_key.json circuits/build/public.json circuits/build/proof.json

6. Export Solidity verifier (to include in contracts):
   snarkjs zkey export solidityverifier circuits/build/YourCircuit_final.zkey contracts/YourCircuitVerifier.sol

Notes:
- The repository already contains a generated Solidity verifier contract inside contracts/ (StateOfResidenceGroth16Verifier). If you replace circuits or re-generate keys, export the updated verifier and integrate it.
- publicSignals ordering and semantics must match what your contract expects. In this project the contract expects specific indexes (e.g., nullifier hash, required state, requestId, requester address, state commitment, etc.)

Contracts (contracts/)
- StateOfResidenceVerifier.sol: Orchestrates requests for state verification, checks user has a valid attestation via an Attester contract, tracks requests, ensures nullifiers are not reused, calls the Groth16 verifier, rewards user with 10% of fee, refunds on rejection, etc.
- StateOfResidenceGroth16Verifier: The on-chain Groth16 verifier (generated by snarkjs). It verifies the submitted proof and public signals.

Common Hardhat commands
- Compile: npx hardhat compile
- Test: npx hardhat test
- Run a script: npx hardhat run scripts/<script>.js --network <network>
- Local node: npx hardhat node

Scripts (scripts/)
- Typical scripts included in this repo may:
  - deploy contracts
  - interact with contract functions for requesting or completing verification
  - helper scripts to fund accounts or simulate Attester contract behavior
- To run deploy:
  npx hardhat run --network localhost scripts/deploy.js

Environment and configuration
- Networks and private keys are defined in hardhat.config.js (not shown here). For local testing use the built-in Hardhat network.
- When deploying to public testnets/mainnet, set RPC URLs and private keys via environment variables. Never commit private keys.

How to use the StateOfResidenceVerifier contract (high-level)
1. Requester calls requestStateVerification(userAddress, requiredState) and pays the required fee (stateVerificationFee).
2. The contract checks the Attester contract to ensure the user has a valid card and stores the request.
3. User generates a ZK proof off-chain that proves:
   - their state commitment matches a committed state
   - the required state matches the requested value
   - the proof includes a nullifier to prevent reuse
   - the requestId and requester are included in public signals so on-chain checks can verify link
4. User calls completeStateVerification(requestId, proof, publicSignals). The contract:
   - verifies public signals match the stored request and commitments retrieved from the Attester
   - calls the Groth16 verifier contract to validate the proof
   - marks request completed and rewards user a portion of the fee

Key developer tips
- Keep public signal ordering consistent between Circom circuit and the Solidity contract checks.
- Use deterministic input.json when testing to reproduce proofs.
- If you recompile/alter circuits, re-run the trusted setup (zkey) and re-export the solidity verifier to keep verifier code and keys in sync.
- Don't expose private keys or sensitive data in public.json or proof artifacts.

Folder overview
- circuits/   : Circom circuits (.circom), test inputs, and build output (wasm, r1cs, zkey artifacts)
- contracts/  : Solidity contracts (verifier + coordination contract)
- scripts/    : Hardhat scripts to deploy and interact with contracts
- test/       : Hardhat tests (unit/integration)
- artifacts/  : Hardhat build artifacts after compilation

Troubleshooting
- "Invalid ZK proof" on-chain: verify you used the correct zkey/verification key and that publicSignals order matches contract checks.
- "Proof has already been used": nullifier public signal was already marked used â€” ensure unique nullifiers per proof.
- Circom or snarkjs errors: check versions. Use circom v2 + matching snarkjs versions where Groth16 toolchain is supported.

Further reading and links
- Circom docs: https://docs.circom.io/
- snarkjs: https://github.com/iden3/snarkjs
- Hardhat: https://hardhat.org/
- Ethers.js (used by Hardhat scripts): https://docs.ethers.io/

If you need a hands-on example for a specific circuit or a tailored deploy/test script, indicate which part you want automated and the expected network (local / testnet).
